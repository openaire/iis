<workflow-app xmlns="uri:oozie:workflow:0.4" name="mainworkflows_preprocessing_export">
	
	<parameters>
		<!-- input ports -->
		<property>
			<name>input_document_to_project</name>
			<value>$UNDEFINED$</value>
		</property>
		<property>
			<name>input_document_to_project_concepts</name>
			<value>$UNDEFINED$</value>
		</property>
		<property>
			<name>input_document_to_dataset</name>
			<value>$UNDEFINED$</value>
		</property>
		<property>
			<name>input_document_to_mdstore</name>
			<value>$UNDEFINED$</value>
		</property>
		<property>
			<name>output_remote_location</name>
			<value>$UNDEFINED$</value>
			<description>optional remote cluster output location where inference output dump should be distcped as sequence files.
			When not specified results will be exported straight to the ActionManager HBase.</description>
		</property>
		<property>
			<name>mdstore_service_location</name>
			<value>$UNDEFINED$</value>
			<description>mdstore service location required for reading dataset and publication entities which will be exported to action manager</description>
		</property>
		<property>
			<name>wos_mdstore_id</name>
			<value>$UNDEFINED$</value>
			<description>mdstore holding WoS publication entities to be exported</description>
		</property>
		<!-- export related -->
		<property>
			<name>action_hbase_table_name</name>
			<description>action manager hbase table name</description>
		</property>
		<property>
			<name>action_hbase_table_initialize</name>
			<description>flag indicating input table should be initialized</description>
		</property>
		<!-- action set id properties -->
		<property>
			<name>action_set_id</name>
			<value>$UNDEFINED$</value>
			<description>action-set identifier of exported data</description>
		</property>
		<property>
			<name>action_set_id_document_referencedProjects</name>
			<value>$UNDEFINED$</value>
			<description>document_referencedProjects action-set identifier of exported data</description>
		</property>
		<property>
			<name>action_set_id_document_referencedDatasets</name>
			<value>$UNDEFINED$</value>
			<description>document_referencedDatasets action-set identifier of exported data</description>
		</property>
		<property>
			<name>action_set_id_entity_wos</name>
			<value>$UNDEFINED$</value>
			<description>action-set identifier of exported data containing wos entities</description>
		</property>
		<property>
			<name>action_set_id_entity_dataset</name>
			<value>$UNDEFINED$</value>
			<description>action-set identifier of exported data containing dataset entities</description>
		</property>
		<!-- trust level threshold section -->
		<property>
			<name>trust_level_threshold</name>
			<value>$UNDEFINED$</value>
			<description>default trust level threshold of exported data</description>
		</property>
		<property>
			<name>trust_level_threshold_document_referencedProjects</name>
			<value>$UNDEFINED$</value>
			<description>document_referencedProjects trust level threshold</description>
		</property>
		<property>
			<name>trust_level_threshold_document_referencedDatasets</name>
			<value>$UNDEFINED$</value>
			<description>document_referencedDatasets trust level threshold</description>
		</property>
		<!--  -->
		<property>
			<name>action_hbase_remote_zookeeper_quorum</name>
			<value>$UNDEFINED$</value>
			<description>external hbase zookeeper quorum, set to empty value by default which means data will be exported to local hbase instance</description>
		</property>
		<property>
			<name>action_hbase_remote_zookeeper_clientport</name>
			<value>$UNDEFINED$</value>
			<description>external hbase zookeeper client port, required only whe zookeeper quorum property is set</description>
		</property>
	</parameters>

	<global>
        <job-tracker>${jobTracker}</job-tracker>
        <name-node>${nameNode}</name-node>
        <configuration>
            <property>
                <name>mapred.job.queue.name</name>
                <value>${queueName}</value>
            </property>
            <property>
                <name>oozie.launcher.mapred.job.queue.name</name>
                <value>${oozieLauncherQueueName}</value>
            </property>
		</configuration>
	</global>

	<start to="decision-export_to_sequencefile_or_hbase" />
    
    <decision name="decision-export_to_sequencefile_or_hbase">
        <switch>
            <case to="export_actionmanager">${output_remote_location eq "$UNDEFINED$"}</case>
            <default to="export_actionmanager_sequencefile"/>
        </switch>
    </decision>
    
  	<action name="export_actionmanager">
		<sub-workflow>
            <app-path>${wf:appPath()}/export_actionmanager</app-path>
            <propagate-configuration/>
            <configuration>
            	<property>
                    <name>workingDir</name>
                    <value>${workingDir}/export_actionmanager/working_dir</value>
                </property>
            </configuration>
        </sub-workflow>
		<ok to="export_entities_forking"/>
		<error to="fail" />
	</action>
 
 	<action name="export_actionmanager_sequencefile">
		<sub-workflow>
            <app-path>${wf:appPath()}/export_actionmanager_sequencefile</app-path>
            <propagate-configuration/>
            <configuration>
            	<property>
                    <name>workingDir</name>
                    <value>${workingDir}/export_actionmanager_sequencefile/working_dir</value>
                </property>
                <property>
                    <name>output</name>
                    <value>${workingDir}/output</value>
                </property>
            </configuration>
        </sub-workflow>
		<ok to="export_entities_forking"/>
		<error to="fail" />
	</action>
 
 	<fork name="export_entities_forking">
    	<path start="transformers_export_identifier_document_to_dataset"/>
    	<path start="transformers_export_identifier_document_to_project"/>
    </fork>
 
	<!-- dataset entities export section --> 
 	<action name="transformers_export_identifier_document_to_dataset">
	    <sub-workflow>
            <app-path>${wf:appPath()}/transformers_export_identifier_document_to_dataset</app-path>
            <propagate-configuration/>
            <configuration>
				<property>
                    <name>workingDir</name>
                    <value>${workingDir}/export_identifier_document_to_dataset/working_dir</value>
                </property>
				<property>
					<name>input_document_to_dataset</name>
					<value>${input_document_to_dataset}</value>
				</property>
				<property>
					<name>input_document_to_mdstore</name>
					<value>${input_document_to_mdstore}</value>
				</property>
				<property>
					<name>output_document_to_mdstore</name>
					<value>${workingDir}/identifier/datasets</value>
				</property>
            </configuration>
        </sub-workflow>
        <ok to="exporter-dataset-entities"/>
		<error to="fail" />
    </action>
 
 	<action name="exporter-dataset-entities">
		<java>
			<main-class>eu.dnetlib.iis.common.java.ProcessWrapper</main-class>
			<arg>eu.dnetlib.iis.wf.export.actionmanager.entity.dataset.DatasetExporterProcess</arg>
			<arg>-Iinput=${workingDir}/identifier/datasets</arg>
			
			<arg>-Pexport.entity.mdstore.service.location=${mdstore_service_location}</arg>
			<arg>-Pexport.action.setid=${action_set_id_entity_dataset}</arg>
			<arg>-Pexport.action.hbase.table.name=${action_hbase_table_name}</arg>
			<arg>-Pexport.action.hbase.remote.zookeeper.quorum=${action_hbase_remote_zookeeper_quorum}</arg>
			<arg>-Pexport.action.hbase.remote.zookeeper.clientport=${action_hbase_remote_zookeeper_clientport}</arg>
			<arg>-Pexport.seq.file.active=${output_remote_location ne "$UNDEFINED$"}</arg>
			<arg>-Pexport.seq.file.output.dir.root=${workingDir}/output/entities_dataset</arg>
			<arg>-Pexport.seq.file.output.dir.name=${action_set_id_entity_dataset}</arg>
		</java>
		<ok to="export_entities_joining" />
		<error to="fail" />
	</action>
    <!-- end of dataset entities export section -->
    
    <!-- publication entities export section -->
 	<action name="transformers_export_identifier_document_to_project">
	    <sub-workflow>
            <app-path>${wf:appPath()}/transformers_export_identifier_document_to_project</app-path>
            <propagate-configuration/>
            <configuration>
				<property>
                    <name>workingDir</name>
                    <value>${workingDir}/export_identifier_documents/working_dir</value>
                </property>
                <property>
					<name>input_document_to_project</name>
					<value>${input_document_to_project}</value>
				</property>
				<property>
					<name>output_identifier</name>
					<value>${workingDir}/identifier/documents</value>
				</property>
            </configuration>
        </sub-workflow>
        <ok to="exporter-document-entities"/>
		<error to="fail" />
    </action>
 
 	<action name="exporter-document-entities">
		<java>
			<main-class>eu.dnetlib.iis.common.java.ProcessWrapper</main-class>
			<arg>eu.dnetlib.iis.wf.export.actionmanager.entity.document.DocumentExporterProcess</arg>
			<arg>-Iinput=${workingDir}/identifier/documents</arg>
			
			<arg>-Pexport.entity.mdstore.service.location=${mdstore_service_location}</arg>
			<arg>-Pexport.entity.mdstore.id=${wos_mdstore_id}</arg>
			<arg>-Pexport.action.setid=${action_set_id_entity_wos}</arg>
			<arg>-Pexport.action.hbase.table.name=${action_hbase_table_name}</arg>
			<arg>-Pexport.action.hbase.remote.zookeeper.quorum=${action_hbase_remote_zookeeper_quorum}</arg>
			<arg>-Pexport.action.hbase.remote.zookeeper.clientport=${action_hbase_remote_zookeeper_clientport}</arg>
			<arg>-Pexport.seq.file.active=${output_remote_location ne "$UNDEFINED$"}</arg>
			<arg>-Pexport.seq.file.output.dir.root=${workingDir}/output/entities_document</arg>
			<arg>-Pexport.seq.file.output.dir.name=${action_set_id_entity_wos}</arg>
		</java>
		<ok to="export_entities_joining" />
		<error to="fail" />
	</action>
    <!-- end of publication entities export section -->
    
    <join name="export_entities_joining" to="decision-distcp_output"/>

    <decision name="decision-distcp_output">
        <switch>
            <case to="distcp_output">${output_remote_location ne "$UNDEFINED$"}</case>
            <default to="end"/>
        </switch>
    </decision>
    
	<action name="distcp_output">
		<distcp xmlns="uri:oozie:distcp-action:0.1">
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<arg>-pb</arg>
			<arg>${nameNode}${workingDir}/output</arg>
			<arg>${output_remote_location}</arg>
		</distcp>
		<ok to="end" />
		<error to="fail" />
	</action>
    
	<kill name="fail">
		<message>Unfortunately, the process failed -- error message:
			[${wf:errorMessage(wf:lastErrorNode())}]</message>
	</kill>
	<end name="end" />
</workflow-app>
